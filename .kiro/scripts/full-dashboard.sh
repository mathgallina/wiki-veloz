#!/bin/bash

# full-dashboard.sh - Dashboard consolidado completo CDD
# Uso: ./full-dashboard.sh [--json] [--save-report] [--detailed]

set -e

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Flags
JSON_OUTPUT=false
SAVE_REPORT=false
DETAILED_OUTPUT=false
REPORT_DIR=".kiro/reports"

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --json)
            JSON_OUTPUT=true
            shift
            ;;
        --save-report)
            SAVE_REPORT=true
            shift
            ;;
        --detailed)
            DETAILED_OUTPUT=true
            shift
            ;;
        -h|--help)
            echo "Uso: $0 [--json] [--save-report] [--detailed]"
            echo ""
            echo "Op√ß√µes:"
            echo "  --json          Sa√≠da em formato JSON"
            echo "  --save-report   Salvar relat√≥rio em arquivo"
            echo "  --detailed      Incluir an√°lises detalhadas"
            echo "  -h              Mostrar esta ajuda"
            exit 0
            ;;
        *)
            echo "Op√ß√£o desconhecida: $1"
            exit 1
            ;;
    esac
done

# Verificar se estamos no diret√≥rio correto
if [ ! -d ".kiro" ]; then
    echo "‚ùå Erro: Diret√≥rio .kiro n√£o encontrado!"
    echo "Execute este script no diret√≥rio raiz do projeto"
    exit 1
fi

# Preparar diret√≥rio de relat√≥rios
if [ "$SAVE_REPORT" = true ]; then
    mkdir -p "$REPORT_DIR"
fi

# Fun√ß√£o para executar script e capturar sa√≠da
run_metric_script() {
    local script_name="$1"
    local script_args="$2"
    
    if [ -f ".kiro/scripts/$script_name" ]; then
        cd .kiro/scripts
        if [ "$JSON_OUTPUT" = true ]; then
            ./"$script_name" --json $script_args 2>/dev/null || echo "{\"error\": \"Failed to run $script_name\"}"
        else
            ./"$script_name" $script_args 2>/dev/null || echo "Erro ao executar $script_name"
        fi
        cd - >/dev/null
    else
        if [ "$JSON_OUTPUT" = true ]; then
            echo "{\"error\": \"Script $script_name not found\"}"
        else
            echo "Script $script_name n√£o encontrado"
        fi
    fi
}

# Fun√ß√£o para header
print_header() {
    if [ "$JSON_OUTPUT" = false ]; then
        echo -e "${BOLD}${PURPLE}üìä CDD DASHBOARD COMPLETO${NC}"
        echo -e "${CYAN}Projeto: $(basename "$(pwd)")${NC}"
        echo -e "${BLUE}Gerado em: $(date "+%Y-%m-%d %H:%M:%S")${NC}"
        echo "=========================================================="
    fi
}

# Fun√ß√£o para calcular score geral
calculate_overall_score() {
    local completeness_score="$1"
    local quality_score="$2"
    local progress_score="$3"
    
    # Pesos das m√©tricas
    local completeness_weight=30
    local quality_weight=40
    local progress_weight=30
    
    local total_score=$(((completeness_score * completeness_weight + quality_score * quality_weight + progress_score * progress_weight) / 100))
    echo $total_score
}

# Fun√ß√£o para determinar status do projeto
get_project_status() {
    local score="$1"
    
    if [ $score -ge 90 ]; then
        echo "EXCELENTE"
    elif [ $score -ge 80 ]; then
        echo "MUITO_BOM"
    elif [ $score -ge 70 ]; then
        echo "BOM"
    elif [ $score -ge 60 ]; then
        echo "REGULAR"
    elif [ $score -ge 40 ]; then
        echo "PRECISA_MELHORAR"
    else
        echo "CRITICO"
    fi
}

# Executar an√°lises
if [ "$JSON_OUTPUT" = false ]; then
    print_header
    echo ""
    echo -e "${BLUE}üîÑ Executando an√°lises...${NC}"
fi

# Coletar m√©tricas de cada script
if [ "$JSON_OUTPUT" = false ]; then
    echo -e "${BLUE}  üìã Analisando completude...${NC}"
fi
completeness_data=$(run_metric_script "metrics-completeness.sh" "$([ "$DETAILED_OUTPUT" = true ] && echo "--detailed")")

if [ "$JSON_OUTPUT" = false ]; then
    echo -e "${BLUE}  üîç Analisando qualidade do c√≥digo...${NC}"
fi
quality_data=$(run_metric_script "metrics-code-quality.sh" "$([ "$DETAILED_OUTPUT" = true ] && echo "--detailed")")

if [ "$JSON_OUTPUT" = false ]; then
    echo -e "${BLUE}  üìà Analisando progresso...${NC}"
fi
progress_data=$(run_metric_script "metrics-progress.sh" "$([ "$DETAILED_OUTPUT" = true ] && echo "--detailed")")

# Verificar valida√ß√£o do projeto
if [ "$JSON_OUTPUT" = false ]; then
    echo -e "${BLUE}  üîß Validando estrutura...${NC}"
fi
validation_result=0
if [ -f ".kiro/scripts/validate-project.sh" ]; then
    cd .kiro/scripts
    if ./validate-project.sh >/dev/null 2>&1; then
        validation_result=1
    fi
    cd - >/dev/null
fi

# Processar dados para sa√≠da
if [ "$JSON_OUTPUT" = true ]; then
    # Sa√≠da JSON consolidada
    timestamp=$(date -Iseconds)
    project_name=$(basename "$(pwd)")
    
    # Extrair scores dos JSONs (se dispon√≠veis)
    completeness_score=85  # Placeholder - extrair do JSON real
    quality_score=75       # Placeholder - extrair do JSON real
    progress_score=60      # Placeholder - extrair do JSON real
    
    overall_score=$(calculate_overall_score $completeness_score $quality_score $progress_score)
    project_status=$(get_project_status $overall_score)
    
    cat << EOF
{
  "timestamp": "$timestamp",
  "project": "$project_name",
  "dashboard": {
    "overall_score": $overall_score,
    "project_status": "$project_status",
    "validation_passed": $([ $validation_result -eq 1 ] && echo "true" || echo "false")
  },
  "metrics": {
    "completeness": $completeness_data,
    "quality": $quality_data,
    "progress": $progress_data
  },
  "recommendations": [
    "$([ $completeness_score -lt 80 ] && echo "Completar documenta√ß√£o pendente")",
    "$([ $quality_score -lt 80 ] && echo "Melhorar qualidade do c√≥digo")",
    "$([ $progress_score -lt 80 ] && echo "Acelerar desenvolvimento")"
  ]
}
EOF
else
    # Sa√≠da em texto formatado
    echo -e "${BLUE}‚úÖ An√°lise conclu√≠da!${NC}"
    echo ""
    
    # Resumo executivo
    echo -e "${BOLD}üìã RESUMO EXECUTIVO${NC}"
    echo "=========================================================="
    
    # Extrair m√©tricas principais (simuladas)
    total_features=$(find .kiro/specs -mindepth 1 -maxdepth 1 -type d | grep -v "_template" | wc -l)
    total_tasks=$(find .kiro/specs -name "tasks.md" -exec grep -c "^-\s\[" {} \; 2>/dev/null | awk '{s+=$1} END {print s+0}')
    completed_tasks=$(find .kiro/specs -name "tasks.md" -exec grep -c "^-\s\[x\]" {} \; 2>/dev/null | awk '{s+=$1} END {print s+0}')
    
    if [ $total_tasks -gt 0 ]; then
        progress_percent=$((completed_tasks * 100 / total_tasks))
    else
        progress_percent=0
    fi
    
    # Calcular scores
    completeness_score=85  # Seria extra√≠do do JSON real
    quality_score=75       # Seria extra√≠do do JSON real
    progress_score=$progress_percent
    
    overall_score=$(calculate_overall_score $completeness_score $quality_score $progress_score)
    project_status=$(get_project_status $overall_score)
    
    # Status geral
    case $project_status in
        "EXCELENTE")
            echo -e "üìä Status do projeto: ${GREEN}${BOLD}EXCELENTE${NC} ($overall_score/100)"
            echo -e "üéâ ${GREEN}Projeto em excelente estado! Continue assim.${NC}"
            ;;
        "MUITO_BOM")
            echo -e "üìä Status do projeto: ${GREEN}${BOLD}MUITO BOM${NC} ($overall_score/100)"
            echo -e "üëç ${GREEN}Projeto bem estruturado. Pequenos ajustes podem elevar ainda mais.${NC}"
            ;;
        "BOM")
            echo -e "üìä Status do projeto: ${YELLOW}${BOLD}BOM${NC} ($overall_score/100)"
            echo -e "‚ú® ${YELLOW}Projeto em boa forma. Algumas melhorias far√£o diferen√ßa.${NC}"
            ;;
        "REGULAR")
            echo -e "üìä Status do projeto: ${YELLOW}${BOLD}REGULAR${NC} ($overall_score/100)"
            echo -e "‚ö†Ô∏è  ${YELLOW}Projeto funcional, mas precisa de aten√ß√£o.${NC}"
            ;;
        "PRECISA_MELHORAR")
            echo -e "üìä Status do projeto: ${RED}${BOLD}PRECISA MELHORAR${NC} ($overall_score/100)"
            echo -e "üîß ${RED}V√°rias √°reas precisam de melhoria urgente.${NC}"
            ;;
        "CRITICO")
            echo -e "üìä Status do projeto: ${RED}${BOLD}CR√çTICO${NC} ($overall_score/100)"
            echo -e "üö® ${RED}Projeto requer aten√ß√£o imediata em m√∫ltiplas √°reas.${NC}"
            ;;
    esac
    
    echo ""
    echo -e "üéØ Features: ${CYAN}$total_features${NC}"
    echo -e "üìã Tarefas: ${CYAN}$completed_tasks${NC}/${CYAN}$total_tasks${NC} (${CYAN}$progress_percent%${NC})"
    echo -e "üîß Valida√ß√£o: $([ $validation_result -eq 1 ] && echo -e "${GREEN}‚úÖ Passou${NC}" || echo -e "${RED}‚ùå Falhou${NC}")"
    
    # Breakdown de scores
    echo ""
    echo -e "${BOLD}üìä BREAKDOWN DE SCORES${NC}"
    echo "=========================================================="
    
    echo -e "üìã Completude da documenta√ß√£o: ${CYAN}$completeness_score/100${NC}"
    if [ $completeness_score -ge 80 ]; then
        echo -e "   ${GREEN}‚úÖ Documenta√ß√£o bem estruturada${NC}"
    elif [ $completeness_score -ge 60 ]; then
        echo -e "   ${YELLOW}‚ö†Ô∏è  Alguns gaps na documenta√ß√£o${NC}"
    else
        echo -e "   ${RED}‚ùå Documenta√ß√£o incompleta${NC}"
    fi
    
    echo -e "üîç Qualidade do c√≥digo: ${CYAN}$quality_score/100${NC}"
    if [ $quality_score -ge 80 ]; then
        echo -e "   ${GREEN}‚úÖ C√≥digo de alta qualidade${NC}"
    elif [ $quality_score -ge 60 ]; then
        echo -e "   ${YELLOW}‚ö†Ô∏è  Qualidade moderada${NC}"
    else
        echo -e "   ${RED}‚ùå Qualidade precisa melhorar${NC}"
    fi
    
    echo -e "üìà Progresso do desenvolvimento: ${CYAN}$progress_score/100${NC}"
    if [ $progress_score -ge 80 ]; then
        echo -e "   ${GREEN}‚úÖ Desenvolvimento avan√ßado${NC}"
    elif [ $progress_score -ge 50 ]; then
        echo -e "   ${YELLOW}‚ö†Ô∏è  Progresso moderado${NC}"
    else
        echo -e "   ${RED}‚ùå Desenvolvimento inicial${NC}"
    fi
    
    # An√°lises detalhadas
    if [ "$DETAILED_OUTPUT" = true ]; then
        echo ""
        echo -e "${BOLD}üìã AN√ÅLISE DETALHADA DE COMPLETUDE${NC}"
        echo "=========================================================="
        echo "$completeness_data"
        
        echo ""
        echo -e "${BOLD}üîç AN√ÅLISE DETALHADA DE QUALIDADE${NC}"
        echo "=========================================================="
        echo "$quality_data"
        
        echo ""
        echo -e "${BOLD}üìà AN√ÅLISE DETALHADA DE PROGRESSO${NC}"
        echo "=========================================================="
        echo "$progress_data"
    fi
    
    # Recomenda√ß√µes priorit√°rias
    echo ""
    echo -e "${BOLD}üéØ RECOMENDA√á√ïES PRIORIT√ÅRIAS${NC}"
    echo "=========================================================="
    
    recommendations=()
    
    if [ $completeness_score -lt 80 ]; then
        recommendations+=("üìã Completar documenta√ß√£o: Execute ./validate-project.sh --fix")
    fi
    
    if [ $quality_score -lt 80 ]; then
        recommendations+=("üîç Melhorar qualidade: Implemente linting e testes")
    fi
    
    if [ $progress_score -lt 50 ]; then
        recommendations+=("üìà Acelerar desenvolvimento: Revise prioridades e recursos")
    fi
    
    if [ $validation_result -eq 0 ]; then
        recommendations+=("üîß Corrigir estrutura: Execute ./validate-project.sh para detalhes")
    fi
    
    if [ ${#recommendations[@]} -eq 0 ]; then
        echo -e "${GREEN}üéâ Nenhuma recomenda√ß√£o cr√≠tica! Projeto em excelente estado.${NC}"
        echo -e "${BLUE}üí° Continue monitorando regularmente com este dashboard.${NC}"
    else
        for rec in "${recommendations[@]}"; do
            echo -e "üî∏ $rec"
        done
    fi
    
    # Pr√≥ximos passos
    echo ""
    echo -e "${BOLD}üöÄ PR√ìXIMOS PASSOS${NC}"
    echo "=========================================================="
    
    if [ $overall_score -ge 80 ]; then
        echo "üéØ Manter qualidade e finalizar features pendentes"
        echo "üìä Monitorar m√©tricas regularmente"
        echo "üîÑ Preparar para pr√≥xima fase/release"
    elif [ $overall_score -ge 60 ]; then
        echo "üìã Focar nas recomenda√ß√µes priorit√°rias acima"
        echo "üîç Revisar e melhorar √°reas com score baixo"
        echo "üìÖ Definir cronograma para melhorias"
    else
        echo "üö® A√ß√£o imediata necess√°ria nas √°reas cr√≠ticas"
        echo "üë• Considerar revis√£o de processos e recursos"
        echo "üìã Implementar CDD completo seguindo guidelines"
    fi
    
    # Ferramentas √∫teis
    echo ""
    echo -e "${BOLD}üõ†Ô∏è  FERRAMENTAS √öTEIS${NC}"
    echo "=========================================================="
    echo "üìã An√°lise espec√≠fica:"
    echo "  ./metrics-completeness.sh --detailed"
    echo "  ./metrics-code-quality.sh --detailed"
    echo "  ./metrics-progress.sh --detailed"
    echo ""
    echo "üîß A√ß√µes:"
    echo "  ./validate-project.sh --fix"
    echo "  ./new-feature.sh <nome>"
    echo "  npm run complete <task-id>"
    echo ""
    echo "üìä Monitoramento:"
    echo "  ./dashboard.sh --refresh-interval 30"
    echo "  ./full-dashboard.sh --save-report"
fi

# Salvar relat√≥rio se solicitado
if [ "$SAVE_REPORT" = true ]; then
    timestamp=$(date "+%Y%m%d_%H%M%S")
    if [ "$JSON_OUTPUT" = true ]; then
        report_file="$REPORT_DIR/dashboard_$timestamp.json"
    else
        report_file="$REPORT_DIR/dashboard_$timestamp.txt"
    fi
    
    # Reexecutar para capturar sa√≠da completa
    if [ "$JSON_OUTPUT" = true ]; then
        $0 --json $([ "$DETAILED_OUTPUT" = true ] && echo "--detailed") > "$report_file"
    else
        $0 $([ "$DETAILED_OUTPUT" = true ] && echo "--detailed") > "$report_file"
    fi
    
    if [ "$JSON_OUTPUT" = false ]; then
        echo ""
        echo -e "${GREEN}üìÑ Relat√≥rio salvo em: $report_file${NC}"
    fi
fi 