<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerenciamento de PDFs - Wiki Veloz Fibra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <style>
      .pdf-preview {
        max-height: 400px;
        overflow-y: auto;
      }
      .upload-area {
        border: 2px dashed #d1d5db;
        transition: all 0.3s ease;
      }
      .upload-area.dragover {
        border-color: #3b82f6;
        background-color: #eff6ff;
      }
    </style>
  </head>
  <body
    class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-200"
    x-data="pdfManager()"
  >
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 dark:bg-gray-800 dark:shadow-lg dark:border-gray-700">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <div class="flex items-center">
            <a href="/" class="flex items-center">
              <div
                class="w-10 h-10 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg flex items-center justify-center"
              >
                <i class="fas fa-wifi text-white text-sm"></i>
              </div>
              <div class="ml-3">
                <h1 class="text-xl font-bold text-gray-900 dark:text-white">VELOZ FIBRA</h1>
                <p class="text-xs text-gray-500 dark:text-gray-400">Gerenciamento de PDFs</p>
              </div>
            </a>
          </div>

          <div class="flex items-center space-x-4">
            <a href="/" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">
              <i class="fas fa-arrow-left mr-2"></i>Voltar
            </a>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Page Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
          <i class="fas fa-file-pdf text-blue-600 mr-3"></i>
          Gerenciamento de PDFs
        </h1>
        <p class="text-gray-600 dark:text-gray-400"> Faça upload, visualize e gerencie PDFs e outros documentos </p>
      </div>

      <!-- Upload Section -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">
          <i class="fas fa-upload text-green-600 mr-2"></i>
          Upload de Arquivos
        </h2>

        <div
          class="upload-area rounded-lg p-8 text-center"
          @dragover.prevent="dragover = true"
          @dragleave.prevent="dragover = false"
          @drop.prevent="handleDrop($event)"
          :class="{ 'dragover': dragover }"
        >
          <div class="mb-4">
            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">
              Arraste arquivos aqui ou clique para selecionar
            </h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
              Suporta PDF, DOC, DOCX, TXT, JPG, PNG, GIF (máx. 50MB)
            </p>
          </div>

          <input
            type="file"
            @change="handleFileSelect($event)"
            accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif"
            class="hidden"
            id="fileInput"
            multiple
          />

          <button
            @click="$refs.fileInput.click()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors"
          >
            <i class="fas fa-folder-open mr-2"></i>
            Selecionar Arquivos
          </button>
        </div>

        <!-- Upload Progress -->
        <div x-show="uploading" class="mt-4">
          <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-2">
            <div
              class="bg-blue-600 h-2 rounded-full transition-all duration-300"
              :style="`width: ${uploadProgress}%`"
            ></div>
          </div>
          <p class="text-sm text-gray-600 dark:text-gray-400 mt-2" x-text="uploadStatus"></p>
        </div>
      </div>

      <!-- Filters and Search -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-8">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div class="flex items-center space-x-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Filtrar por Página
              </label>
              <select
                x-model="selectedPage"
                @change="filterPdfs()"
                class="border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
              >
                <option value="">Todas as páginas</option>
                <template x-for="page in pages" :key="page.id">
                  <option :value="page.id" x-text="page.title"></option>
                </template>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"> Ordenar por </label>
              <select
                x-model="sortBy"
                @change="sortPdfs()"
                class="border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
              >
                <option value="uploaded_at">Data de Upload</option>
                <option value="original_filename">Nome do Arquivo</option>
                <option value="file_size">Tamanho</option>
                <option value="download_count">Downloads</option>
              </select>
            </div>
          </div>

          <div class="flex-1 max-w-md">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"> Buscar PDFs </label>
            <input
              type="text"
              x-model="searchQuery"
              @input="searchPdfs()"
              placeholder="Buscar por nome ou descrição..."
              class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
            />
          </div>
        </div>
      </div>

      <!-- PDFs List -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
          <h2 class="text-xl font-semibold text-gray-900 dark:text-white">
            <i class="fas fa-list text-blue-600 mr-2"></i>
            Arquivos (<span x-text="filteredPdfs.length"></span>)
          </h2>
        </div>

        <div class="divide-y divide-gray-200 dark:divide-gray-700">
          <template x-for="pdf in filteredPdfs" :key="pdf.id">
            <div class="p-6 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
              <div class="flex items-start justify-between">
                <div class="flex items-start space-x-4 flex-1">
                  <!-- File Icon -->
                  <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-red-100 dark:bg-red-900/20 rounded-lg flex items-center justify-center">
                      <i class="fas fa-file-pdf text-red-600 text-xl"></i>
                    </div>
                  </div>

                  <!-- File Info -->
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between">
                      <h3 class="text-lg font-medium text-gray-900 dark:text-white" x-text="pdf.original_filename"></h3>
                      <div class="flex items-center space-x-2">
                        <span
                          class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300"
                        >
                          <i class="fas fa-download mr-1"></i>
                          <span x-text="pdf.download_count"></span> downloads
                        </span>
                        <span
                          class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-300"
                        >
                          <span x-text="formatFileSize(pdf.file_size)"></span>
                        </span>
                      </div>
                    </div>

                    <p
                      class="text-sm text-gray-500 dark:text-gray-400 mt-1"
                      x-text="pdf.description || 'Sem descrição'"
                    ></p>

                    <div class="flex items-center space-x-4 mt-2 text-sm text-gray-500 dark:text-gray-400">
                      <span>
                        <i class="fas fa-calendar mr-1"></i>
                        <span x-text="formatDate(pdf.uploaded_at)"></span>
                      </span>
                      <span x-show="pdf.page_id">
                        <i class="fas fa-link mr-1"></i>
                        <span x-text="getPageTitle(pdf.page_id)"></span>
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Actions -->
                <div class="flex items-center space-x-2 ml-4">
                  <button
                    @click="viewPdf(pdf.id)"
                    class="p-2 text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 transition-colors"
                    title="Visualizar"
                  >
                    <i class="fas fa-eye"></i>
                  </button>

                  <a
                    :href="`/uploads/${pdf.filename}`"
                    @click="incrementDownload(pdf.id)"
                    class="p-2 text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300 transition-colors"
                    title="Download"
                  >
                    <i class="fas fa-download"></i>
                  </a>

                  <button
                    x-show="currentUser.role === 'admin'"
                    @click="deletePdf(pdf.id)"
                    class="p-2 text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 transition-colors"
                    title="Excluir"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </template>

          <!-- Empty State -->
          <div x-show="filteredPdfs.length === 0" class="p-12 text-center">
            <i class="fas fa-file-pdf text-gray-400 text-4xl mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2"> Nenhum PDF encontrado </h3>
            <p class="text-gray-500 dark:text-gray-400"> Faça upload de seus primeiros arquivos para começar </p>
          </div>
        </div>
      </div>
    </main>

    <!-- PDF Viewer Modal -->
    <div
      x-show="showPdfViewer"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
      @click.self="showPdfViewer = false"
    >
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] flex flex-col">
        <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white" x-text="selectedPdf?.original_filename"></h3>
          <button @click="showPdfViewer = false" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        <div class="flex-1 p-4 overflow-hidden">
          <iframe
            x-show="selectedPdf"
            :src="`/api/pdfs/${selectedPdf?.id}/view`"
            class="w-full h-full border-0 rounded-lg"
            title="PDF Viewer"
          ></iframe>
        </div>
      </div>
    </div>

    <script>
      function pdfManager() {
        return {
          pdfs: [],
          pages: [],
          filteredPdfs: [],
          selectedPage: '',
          sortBy: 'uploaded_at',
          searchQuery: '',
          uploading: false,
          uploadProgress: 0,
          uploadStatus: '',
          dragover: false,
          showPdfViewer: false,
          selectedPdf: null,
          currentUser: {
            role: '{{ current_user.role }}',
          },

          init() {
            this.loadPdfs();
            this.loadPages();
          },

          async loadPdfs() {
            try {
              const response = await fetch('/api/pdfs');
              const data = await response.json();
              this.pdfs = data.pdfs || [];
              this.filteredPdfs = [...this.pdfs];
              this.sortPdfs();
            } catch (error) {
              console.error('Erro ao carregar PDFs:', error);
            }
          },

          async loadPages() {
            try {
              const response = await fetch('/api/pages');
              const data = await response.json();
              this.pages = data.pages || [];
            } catch (error) {
              console.error('Erro ao carregar páginas:', error);
            }
          },

          handleFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
              this.uploadFiles(files);
            }
          },

          handleDrop(event) {
            this.dragover = false;
            const files = event.dataTransfer.files;
            if (files.length > 0) {
              this.uploadFiles(files);
            }
          },

          async uploadFiles(files) {
            this.uploading = true;
            this.uploadProgress = 0;
            this.uploadStatus = 'Iniciando upload...';

            for (let i = 0; i < files.length; i++) {
              const file = files[i];
              this.uploadStatus = `Enviando ${file.name}...`;
              this.uploadProgress = (i / files.length) * 100;

              try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('page_id', this.selectedPage);
                formData.append('description', '');

                const response = await fetch('/api/pdfs', {
                  method: 'POST',
                  body: formData,
                });

                if (response.ok) {
                  const result = await response.json();
                  this.pdfs.push(result.pdf);
                  this.filteredPdfs = [...this.pdfs];
                  this.sortPdfs();
                } else {
                  const error = await response.json();
                  console.error('Erro no upload:', error.error);
                }
              } catch (error) {
                console.error('Erro no upload:', error);
              }
            }

            this.uploading = false;
            this.uploadProgress = 100;
            this.uploadStatus = 'Upload concluído!';

            setTimeout(() => {
              this.uploadStatus = '';
            }, 2000);
          },

          filterPdfs() {
            this.filteredPdfs = this.pdfs.filter(pdf => {
              const matchesPage = !this.selectedPage || pdf.page_id === this.selectedPage;
              const matchesSearch =
                !this.searchQuery ||
                pdf.original_filename.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
                (pdf.description && pdf.description.toLowerCase().includes(this.searchQuery.toLowerCase()));

              return matchesPage && matchesSearch;
            });
            this.sortPdfs();
          },

          searchPdfs() {
            this.filterPdfs();
          },

          sortPdfs() {
            this.filteredPdfs.sort((a, b) => {
              switch (this.sortBy) {
                case 'uploaded_at':
                  return new Date(b.uploaded_at) - new Date(a.uploaded_at);
                case 'original_filename':
                  return a.original_filename.localeCompare(b.original_filename);
                case 'file_size':
                  return b.file_size - a.file_size;
                case 'download_count':
                  return b.download_count - a.download_count;
                default:
                  return 0;
              }
            });
          },

          async deletePdf(pdfId) {
            if (!confirm('Tem certeza que deseja excluir este arquivo?')) {
              return;
            }

            try {
              const response = await fetch(`/api/pdfs/${pdfId}`, {
                method: 'DELETE',
              });

              if (response.ok) {
                this.pdfs = this.pdfs.filter(pdf => pdf.id !== pdfId);
                this.filteredPdfs = this.filteredPdfs.filter(pdf => pdf.id !== pdfId);
              } else {
                const error = await response.json();
                alert('Erro ao excluir arquivo: ' + error.error);
              }
            } catch (error) {
              console.error('Erro ao excluir PDF:', error);
              alert('Erro ao excluir arquivo');
            }
          },

          async incrementDownload(pdfId) {
            // O incremento é feito automaticamente pelo servidor
            // Esta função pode ser usada para feedback visual se necessário
          },

          viewPdf(pdfId) {
            this.selectedPdf = this.pdfs.find(pdf => pdf.id === pdfId);
            this.showPdfViewer = true;
          },

          getPageTitle(pageId) {
            const page = this.pages.find(p => p.id === pageId);
            return page ? page.title : 'Página não encontrada';
          },

          formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
          },

          formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('pt-BR', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
            });
          },
        };
      }
    </script>
  </body>
</html>
